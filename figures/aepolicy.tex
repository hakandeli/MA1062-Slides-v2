
\tikzstyle{network} = [rectangle, 
					minimum width = 3.5cm, 
					minimum height = 2.5cm, 
					text = black!100, 
					align=center, 
					line width = 1, 
					inner sep = 1mm]
					   
\tikzstyle{arrow}=[> = stealth, line width = 0.5pt]

\tikzstyle{dnnnode} = [circle, draw=black, line width = 0.5pt, minimum size=3pt, inner sep = 0mm, on grid]

\tikzstyle{layer} = [rectangle, fill = gray!60, draw = none, line width = 1pt, minimum width=0.5cm, inner sep = 0mm, anchor = center, fill = sapphirelatte!70, rounded corners = 3pt]

\begin{tikzpicture}[x=2cm, y = 1cm]

    % boxes and titles
    \node[rectangle, fill = IKRBlue!20, rounded corners = 5pt, minimum width = 15cm, minimum height = 6.9cm, anchor = center] at (0, 0) {};

    \node[align = center, anchor = west, visible on = <1->] at (-3.65,2.9) {\large Processing Pipeline for $\pi_{\text{AE}}$};

    % nodes

    \begin{scope}[yshift = -0.25cm]


        \node[align = center, visible on = <1->] (input) at (-3.1, -0.45) {demand and \\ topology info};
    
        \node[rectangle, shading = axis, left color = Apricot!20, right color = white, rounded corners = 3pt, minimum height = 50mm, minimum width = 60mm, anchor = center, visible on = <1->] (pre) at (-1, 0) {};
        
        \node[align = center, visible on = <1->] at (-1, 2) {feature encoding};

        \node[rectangle, draw = black, rounded corners = 3pt, anchor = center, minimum width = 4mm, minimum height = 10mm] (preb) at (-2.1,-0.45) {\rotatebox{90}{basic encoding}};

        %Enc1
        \begin{scope}[shift={(-1.1, 0.7)}]
            \fill[Cerulean!60, rounded corners=2pt] (0, 0.4) -- (0.75, 0.7) -- (0.75, -0.7) -- (0, -0.4) -- cycle;
            \node[anchor = center, align = center] (amren) at (0.4, 0) {$\text{Encoder}_{1}$};
        \end{scope}
        
        \begin{scope}[shift={(-1.1, -1.5)}]
            \fill[Cerulean!60, rounded corners=2pt] (0, 0.4) -- (0.75, 0.7) -- (0.75, -0.7) -- (0, -0.4) -- cycle;
            \node[anchor = center, align = center] (amren) at (0.4, 0) {$\text{Encoder}_{N}$};
        \end{scope}

        \node[rectangle, fill = Mulberry!60, rounded corners = 3pt, minimum height = 50mm, minimum width = 40mm, anchor = center, visible on = <1->] (policymix) at (1.75, 0) {};

        \node[align = center, visible on = <1->] at (1.75, 2) {policymix};

        \node[network, minimum height = 1.8cm, minimum width = 2.5cm, fill = BurntOrange!60, rounded corners=3pt, visible on = <1->] (npol) at (1.75, 0.7) {}; 
        
    	\node[network, minimum height = 1.8cm, minimum width = 2.5cm, fill = ForestGreen!60, rounded corners=3pt, visible on = <1->] (nilp) at (1.75, -1.3) {};

        %dnn 1

        \begin{scope}[x=0.1cm, y= 0.2cm, shift = {(2.65cm, 1cm)}, visible on = <1->]

            %white bg
            \node[bgrectw, minimum width = 1cm, minimum height = 1cm, anchor = north] (dnnone) at (3, -0.06) {};
            % \node[align = center] at (3, -4.8) {DNN};
            
    		% Define nodes for each layer
    		\foreach \i in {1,...,4} {
    			\node[dnnnode] (input\i) at (0,-\i) {};
    			\node[dnnnode] (hiddenA\i) at (2,-\i) {};
    			\node[dnnnode] (hiddenB\i) at (4,-\i) {};
    			\node[dnnnode] (output\i) at (6,-\i) {};
    		}
    		
    		% Draw connections
    		\foreach \i in {1,...,4} {
    			\foreach \j in {1,...,4} {
    				\draw[line width = 0.5pt] (input\i) -- (hiddenA\j);
    				\draw[line width = 0.5pt] (hiddenA\i) -- (hiddenB\j);
    				\draw[line width = 0.5pt] (hiddenB\i) -- (output\j);
    			}
    		}
		
        \end{scope}

        \node[layer, minimum height = 10mm, minimum width = 3mm, fill = BrickRed!50, visible on = <1->] (output) at (1.9, 0.48) {};

        \node[rectangle, shading = axis, left color = Apricot!20, right color = white, rounded corners = 3pt, minimum height = 10mm, minimum width = 3mm, anchor = center, visible on = <1->] (post) at (2.15, 0.48) {};

        \node[align = center, visible on = <1->] at (1.75, 1.3) {\small heuristics};

        \node[align = center, visible on = <1->] at (1.75, -0.68) {\small basic};

        % dnn 2

        \begin{scope}[x=0.1cm, y= 0.2cm, shift = {(2.65cm, -1cm)}, visible on = <1->]

            %white bg
            \node[bgrectw, minimum width = 1cm, minimum height = 1cm, anchor = north] (dnntwo) at (3, -0.06) {};
            % \node[align = center] at (3, -4.8) {DNN};
            
    		% Define nodes for each layer
    		\foreach \i in {1,...,4} {
    			\node[dnnnode] (input\i) at (0,-\i) {};
    			\node[dnnnode] (hiddenA\i) at (2,-\i) {};
    			\node[dnnnode] (hiddenB\i) at (4,-\i) {};
    			\node[dnnnode] (output\i) at (6,-\i) {};
    		}
    		
    		% Draw connections
    		\foreach \i in {1,...,4} {
    			\foreach \j in {1,...,4} {
    				\draw[line width = 0.5pt] (input\i) -- (hiddenA\j);
    				\draw[line width = 0.5pt] (hiddenA\i) -- (hiddenB\j);
    				\draw[line width = 0.5pt] (hiddenB\i) -- (output\j);
    			}
    		}
		
        \end{scope}

        \node[layer, minimum height = 10mm, minimum width = 3mm, fill = peachlatte!60, visible on = <1->] (outputtwo) at (1.9, -1.52) {};

        \node[rectangle, shading = axis, left color = Apricot!20, right color = white, rounded corners = 3pt, minimum height = 10mm, minimum width = 3mm, anchor = center, visible on = <1->] (posttwo) at (2.15, -1.52) {};

        \node[align = center, visible on = <1->] (decision) at (3.3, -0.45) {decision};

        % circles

        \node[circle, minimum size = 1.5mm, inner sep = 0mm, fill=black, visible on = <1->] (aein) at (-1.6, -0.45) {};
    
        \node[circle, minimum size = 1.5mm, inner sep = 0mm, fill=black, visible on = <1->] (aeout) at (0.2, -0.45) {};

        \node[circle, minimum size = 1.5mm, inner sep = 0mm, fill=black, visible on = <1->] (polin) at (0.95, -0.45) {};

        % connections

        \draw[arrow, ->, visible on = <1->] (input.east) -- (preb.west);
        \draw[arrow, -, visible on = <1->] (preb.east) -- (aein);

        \draw[arrow, ->, visible on = <1->] (aein) -- (-1.1, 0.65);
        \draw[arrow, ->, dashed, visible on = <1->] (aein) -- (-1.1, -1.55);

        \draw[arrow, <->, dashed, visible on = <1->] (-1.3, 0.1) to[bend left = 30] (-1.3, -0.95); 
        
        \draw[arrow, -, visible on = <1->] (-0.35, 0.65) -- (aeout);
        \draw[arrow, -, dashed, visible on = <1->] (-0.35, -1.5) -- (aeout);

        \draw[arrow, -, visible on = <1->] (aeout) -- (polin);

        \draw[arrow, -, visible on = <1->] (polin) |- (npol.west);
        \draw[arrow, -, visible on = <1->] (polin) |- (nilp.west);

        \draw[arrow, -, visible on = <1->] (polin) |- (npol.west);
        \draw[arrow, ->, visible on = <1->] (npol.west) -- (dnnone.west);
        \draw[arrow, ->, visible on = <1->] (dnnone.east) -- (output.west);
        \draw[arrow, ->, visible on = <1->] (output.east) -- (post.west);
        \draw[arrow, -, visible on = <1->] (post.east) -- (npol.east);


        \draw[arrow, -, visible on = <1->] (polin) |- (nilp.west);
        \draw[arrow, ->, visible on = <1->] (nilp.west) -- (dnntwo.west);
        \draw[arrow, ->, visible on = <1->] (dnntwo.east) -- (outputtwo.west);
        \draw[arrow, ->, visible on = <1->] (outputtwo.east) -- (posttwo.west);
        \draw[arrow, -, visible on = <1->] (posttwo.east) -- (nilp.east);

        \node[circle, minimum size = 1.5mm, inner sep = 0mm, fill = black, right = 0.3cm of nilp] (dummy) {};
        \draw[arrow, ->, visible on = <1->] (npol.east) -| (dummy);
        \draw[arrow, ->, visible on = <1->] (nilp.east) -- (dummy);
        % \draw[arrow, -, visible on = <1->] (nilp.east) -| (dummy.center);

        \draw[arrow, ->, visible on = <1->] ($(dummy.center)+(0, 0.3)$) -- ($(nilp.east)+(0, 0.3)$);

        \draw[arrow, ->, visible on = <1->] (dummy) -| (decision);

    \end{scope}
 
  % help lines
  % \draw[step=1cm, help lines, color=gray!50] (-3,-3) grid (3,3);
  % % Label grid coordinates
  % \foreach \x in {-3,...,3}
  %   \foreach \y in {-3,...,3}
  %     \node[fill=white] at (\x,\y) {\tiny (\x,\y)};
	 
\end{tikzpicture}





% OLD AE POLICY TIKZ

% \tikzstyle{layer} = [rectangle,
% 					draw, 
% 					   minimum width = 0.75cm, 
% 					   minimum height = 2cm, 
% 					   text = black!100, 
% 					   align=center,
% 					   rotate=90, 
% 					   line width = 1, 
% 					   inner sep = 0mm]
				
% \tikzstyle{network} = [rectangle, 
% 					minimum width = 3cm, 
% 					minimum height = 2cm, 
% 					text = black!100, 
% 					align=center, 
% 					line width = 1, 
% 					inner sep = 1mm]
					   
% \tikzstyle{arrow}=[> = stealth, line width = 0.5pt]


% \begin{tikzpicture}[x=2cm, y = 1.7cm, scale = 1]

%     \node[rectangle, fill = IKRBlue!20, rounded corners = 0pt, minimum width = 14cm, minimum height = 6.3cm, anchor = center] at (3.2, 0) {};
%     \node[rectangle, shading = axis, right color = IKRBlue!20, left color = white, rounded corners = 0pt, minimum width = 0.5cm, minimum height = 6.3cm, anchor = center] at (-0.3, 0) {};
%     \node[rectangle, shading = axis, right color = white, left color = IKRBlue!20, rounded corners = 0pt, minimum width = 0.5cm, minimum height = 6.3cm, anchor = center] at (6.7, 0) {};

    
% 	\node[] (input) at (-0.1, 0) {$\mathbf{x}$};

%     \begin{scope}[shift={(1.5,1)}]
%         \fill[Purple!60, rounded corners=2pt] (0, -0.4) -- (0, 0.4) -- (0.9, 0.75) -- (0.9, -0.75) -- cycle;
%         \node[anchor = center] (amren) at (0.45, 0) {$\text{AE}_{1}$};
%     \end{scope}

%     \begin{scope}[shift={(1.5,-1)}]
%         \fill[WildStrawberry!50, rounded corners=2pt] (0, -0.4) -- (0, 0.4) -- (0.9, 0.75) -- (0.9, -0.75) -- cycle;
%         \node[anchor = center] (al42) at (0.45, 0) {$\text{AE}_{2}$};
%     \end{scope}

%     \node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (cinput) at (0.5, 0) {};
% 	\node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (cmren) at (2.6, 1) {};
% 	\node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (cl42) at (2.6, -1) {};
%     \node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (cmrenv) at (1.3, 1) {};
% 	\node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (cl42v) at (1.3, -1) {};
% 	\node[circle, minimum size = 2mm, inner sep = 0mm, fill=black] (c) at (3.4, 0) {};
% 	\node[network, fill = CornflowerBlue!60, rounded corners=3pt, minimum height = 2.5cm, align = center, baseline] (n) at (4.9, 0) {policymix model};
% 	\node[align = center, baseline] (output) at (6.5, 0) {\textbf{y}};
	
% 	% \draw[->, arrow, shorten <= 1mm, shorten >= 2mm] (input) -- (amren.west);
% 	% \draw[->, arrow, shorten <= 1mm, shorten >= 2mm] (input) -- (alayer42.west);

%     \draw[->, arrow] (-0.5, 0) -- (input);
%     \draw[-, arrow] (input) -- (cinput.center);
%     \draw[->, arrow] (cinput.center) |- (cmrenv);
%     \draw[->, arrow, loosely dashed] (cinput.center) |- (cl42v);

%     \draw[-, line width=0.5pt] (cmrenv.center) -- (1.5,1);
%     \draw[-, line width=0.5pt] (cl42v.center) -- (1.5,-1);

%     \draw[-, line width=0.5pt] (2.4,1) -- (cmren.center);
% 	\draw[-, line width=0.5pt] (cmren.center) -| (c.center);
% 	\draw[->, arrow, shorten >= 0mm] (c.center) -- (n);

%     \draw[-, line width=0.5pt] (2.4,-1) -| (cl42.center);
%     \draw[-, line width=0.5pt, loosely dashed] (cl42.center) -| (c.center);

%     \draw[->, arrow, shorten >= 0mm] (n) -- (output);
%     \draw[->, arrow] (output) -- (6.9, 0);

%     \node[] at (0, -1.6) {$\pi_{\text{AE}}$};
	     
	 
% \end{tikzpicture}